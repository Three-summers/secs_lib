# secs_lib 架构总览

> 文档生成日期：2026-01-07
> 基于源码版本：当前 main 分支

## 项目简介

`secs_lib` 是一个现代 C++20 实现的 SECS/GEM 协议库，支持半导体设备与主机（Host）之间的通信。该库实现了以下 SEMI 标准：

- **SECS-I（SEMI E4）**：串口半双工传输层
- **SECS-II（SEMI E5）**：消息内容编解码层
- **HSMS（SEMI E37）**：TCP/IP 全双工传输层

---

## 架构层次图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              应用层                                         │
│                                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                         C API (c_api)                               │   │
│   │              FFI 封装层，供其他语言调用                              │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      SML Runtime (sml)                              │   │
│   │          消息模板语言解析器与运行时查询引擎                          │   │
│   │                  Lexer → Parser → Runtime                           │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
├────────────────────────────────────┼────────────────────────────────────────┤
│                              协议层                                         │
│                                    │                                        │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                    Protocol Session (protocol)                      │   │
│   │         统一会话抽象：Router + Session + SystemBytes                 │   │
│   │              支持 HSMS 与 SECS-I 透明切换                            │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│          ┌─────────────────────────┴─────────────────────────┐              │
│          │                                                   │              │
│   ┌──────┴──────────────────┐                 ┌──────────────┴───────┐      │
│   │      HSMS (hsms)        │                 │     SECS-I (secs1)   │      │
│   │   TCP/IP 全双工传输     │                 │    串口半双工传输    │      │
│   │  - Connection          │                 │  - Port              │      │
│   │  - Session FSM         │                 │  - Handshake FSM     │      │
│   │  - T3/T5/T6/T7/T8      │                 │  - T1/T2/T3/T4       │      │
│   └─────────────────────────┘                 └──────────────────────┘      │
│                                    │                                        │
├────────────────────────────────────┼────────────────────────────────────────┤
│                            消息内容层                                       │
│                                    │                                        │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                      SECS-II (ii)                                   │   │
│   │               消息内容编解码与数据结构                               │   │
│   │          Item 类型体系 + Codec 编解码器                             │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
├────────────────────────────────────┼────────────────────────────────────────┤
│                              基础层                                         │
│                                    │                                        │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │                       Core (core)                                   │   │
│   │                    基础类型与错误处理                                │   │
│   │         byte, span, error_code, async primitives                    │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 模块依赖关系

```
                     ┌───────────┐
                     │  c_api    │
                     └─────┬─────┘
                           │
                     ┌─────▼─────┐
                     │    sml    │
                     └─────┬─────┘
                           │
                     ┌─────▼─────┐
                     │ protocol  │
                     └─────┬─────┘
                           │
            ┌──────────────┼──────────────┐
            │              │              │
      ┌─────▼─────┐  ┌─────▼─────┐  (共享)
      │   hsms    │  │  secs1    │
      └─────┬─────┘  └─────┬─────┘
            │              │
            └──────┬───────┘
                   │
             ┌─────▼─────┐
             │    ii     │
             └─────┬─────┘
                   │
             ┌─────▼─────┐
             │   core    │
             └───────────┘
```

---

## 文档清单

| 序号 | 模块 | 文档 | 主要内容 |
|------|------|------|----------|
| 01 | core | [01-core-module.md](01-core-module.md) | 基础类型、错误处理、跨平台适配 |
| 02 | ii (SECS-II) | [02-secs-ii-module.md](02-secs-ii-module.md) | Item 类型体系、编解码器、FormatByte |
| 03 | hsms | [03-hsms-module.md](03-hsms-module.md) | TCP 连接管理、会话状态机、控制消息 |
| 04 | secs1 | [04-secs1-module.md](04-secs1-module.md) | 串口通信、握手协议、Block 分片 |
| 05 | protocol | [05-protocol-module.md](05-protocol-module.md) | 统一会话抽象、消息路由、SystemBytes |
| 06 | sml | [06-sml-module.md](06-sml-module.md) | SML 语法、词法/语法分析、运行时 |

---

## 技术栈

| 技术 | 用途 |
|------|------|
| C++20 | 语言标准，使用 concepts、coroutines、ranges |
| standalone Asio | 异步 I/O 框架（无 Boost 依赖） |
| CMake | 构建系统 |
| GoogleTest | 单元测试框架 |
| spdlog | 日志库（可选） |

---

## 关键设计决策

### 1. 协程驱动的异步模型

所有 I/O 操作使用 `asio::awaitable<T>` 协程，通过 `co_await` 实现非阻塞：

```cpp
asio::awaitable<void> example() {
    auto result = co_await session.async_request(stream, func, body);
    if (result) {
        process(*result);
    }
}
```

### 2. 统一错误处理

全局使用 `std::error_code` 而非异常：

```cpp
std::error_code ec = operation();
if (ec) {
    log_error(ec.message());
    return ec;
}
```

### 3. 零拷贝优先

- 解码时使用 `std::span<const byte>` 避免复制
- Item 使用变体类型存储，无虚函数开销
- 编码时预分配缓冲区

### 4. 传输层透明

`protocol::Session` 抽象屏蔽 HSMS 与 SECS-I 差异：

```cpp
// 相同的 API，不同的后端
Session session(hsms_connection);   // HSMS over TCP
Session session(secs1_port);        // SECS-I over Serial
```

---

## 数据流示意图

### 发送路径

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            发送流程                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  应用层                                                                  │
│    │                                                                    │
│    │  构造 ii::Item                                                     │
│    ▼                                                                    │
│  ┌─────────────────────┐                                               │
│  │  ii::encode(item)   │  → 序列化为字节流                             │
│  └──────────┬──────────┘                                               │
│             │                                                           │
│             ▼                                                           │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │              protocol::Session::async_send()                    │   │
│  │                                                                  │   │
│  │  分配 SystemBytes → 构造 DataMessage → 选择后端                 │   │
│  └─────────────────────────────┬───────────────────────────────────┘   │
│                                │                                        │
│               ┌────────────────┴────────────────┐                       │
│               │                                 │                       │
│               ▼                                 ▼                       │
│  ┌────────────────────────┐       ┌────────────────────────┐           │
│  │     HSMS 路径          │       │     SECS-I 路径        │           │
│  │                        │       │                        │           │
│  │  构造 HSMS 帧          │       │  Block 分片            │           │
│  │  Length(4) + Header    │       │  添加 Checksum         │           │
│  │  + Body                │       │  ENQ/EOT 握手          │           │
│  │                        │       │                        │           │
│  │  TCP send              │       │  串口 write            │           │
│  └────────────────────────┘       └────────────────────────┘           │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 接收路径

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            接收流程                                     │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌────────────────────────┐       ┌────────────────────────┐           │
│  │     HSMS 路径          │       │     SECS-I 路径        │           │
│  │                        │       │                        │           │
│  │  TCP recv              │       │  串口 read             │           │
│  │  解析 HSMS 帧          │       │  校验握手字节          │           │
│  │  提取 Header + Body    │       │  Block 重组            │           │
│  └────────────┬───────────┘       └────────────┬───────────┘           │
│               │                                 │                       │
│               └────────────────┬────────────────┘                       │
│                                │                                        │
│                                ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │              protocol::Session 接收循环                         │   │
│  │                                                                  │   │
│  │  1. 检查是否为 pending 请求的响应                               │   │
│  │  2. 若是，通过 Event 唤醒等待协程                               │   │
│  │  3. 若否，查找 Router 注册的 Handler                            │   │
│  │  4. 调用 Handler 处理                                           │   │
│  └─────────────────────────────┬───────────────────────────────────┘   │
│                                │                                        │
│                                ▼                                        │
│  ┌─────────────────────┐                                               │
│  │  ii::decode(body)   │  → 反序列化为 ii::Item                        │
│  └──────────┬──────────┘                                               │
│             │                                                           │
│             ▼                                                           │
│  应用层处理                                                              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 快速开始

### 构建

```bash
mkdir build && cd build
cmake .. -DCMAKE_BUILD_TYPE=Release
cmake --build .
```

### 示例：HSMS 连接

```cpp
#include <secs/hsms/connection.hpp>
#include <secs/protocol/session.hpp>
#include <secs/ii/item.hpp>

asio::awaitable<void> run_client(asio::io_context& ctx) {
    hsms::ConnectionOptions opts;
    opts.remote_address = "192.168.1.100";
    opts.remote_port = 5000;
    opts.mode = hsms::ConnectionMode::Active;

    hsms::Connection conn(ctx, opts);
    co_await conn.async_connect();
    co_await conn.async_select();

    protocol::Session session(conn);

    // 发送 S1F1 并等待 S1F2 响应
    auto result = co_await session.async_request(1, 1, {});
    if (result) {
        auto item = ii::decode_one(result->body);
        // 处理响应...
    }
}
```

### 示例：SML 配置

```cpp
#include <secs/sml/runtime.hpp>

sml::Runtime runtime;
auto ec = runtime.load(R"(
    // 消息模板
    establish: S1F13 W <L <A ""> <A "1.0.0">>.
    establish_ack: S1F14 <L <U2 0> <L <A "EQ"> <A "2.0">>>.

    // 自动响应规则
    if (S1F13) establish_ack.

    // 心跳定时器
    heartbeat: S1F1 W.
    every 30 send heartbeat.
)");

// 查找消息模板
const auto* msg = runtime.get_message("establish");
auto body = ii::encode(msg->item);
```

---

## 源文件统计

| 模块 | 头文件数 | 源文件数 | 总行数（约） |
|------|----------|----------|--------------|
| core | 4 | 1 | ~350 |
| ii | 4 | 2 | ~1,200 |
| hsms | 4 | 3 | ~1,800 |
| secs1 | 5 | 4 | ~1,500 |
| protocol | 3 | 3 | ~900 |
| sml | 5 | 3 | ~1,600 |
| **总计** | **25** | **16** | **~7,350** |

---

## 版本历史

| 版本 | 日期 | 主要变更 |
|------|------|----------|
| 1.0 | 2026-01-07 | 初始版本，完成全部模块文档 |

---

## 相关资源

- SEMI E4-0699：SECS-I 标准
- SEMI E5-0200：SECS-II 标准
- SEMI E37-0999：HSMS 标准
- [Asio C++ Library](https://think-async.com/Asio/)
